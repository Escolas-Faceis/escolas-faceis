<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Perfil</title>
  <link rel="stylesheet" href="/css/info.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" />
    <link rel="stylesheet" href="/css/modal.css">
</head>

  <script src="/js/mascaras.js"></script>
    <script>
        function notify(title, text, type, position, timeout = 5000) {
            new Notify({
                status: type,
                title: title,
                text: text,
                effect: 'fade',
                speed: 500,
                showIcon: true,
                showCloseButton: true,
                autoclose: true,
                autotimeout: timeout,
                gap: 20,
                distance: 20,
                type: 1,
                position: position
            });
        }
    </script>

        <style>
            
        :root {
            --background_banner: <%= valores.cor_banner || '#C7D3DD' %>;
        }
        #banner_perfil {
            background-color: var(--background_banner);
        }
    </style>

    <body>
    <%
    let arquivo = {"imagem":"../imagem/perfil-foto.png"}
        if(valores.img_perfil_pasta != null){
            arquivo.imagem = valores.img_perfil_pasta
        }else if(valores.img_perfil_banco != null){
            arquivo.imagem = valores.img_perfil_banco;
        }
    let  msgErro = "";
    let  erroValidacao =  {"nome":"","email":"","password":"","reppassword":"","cellphone":""};
    let  avisoErro =  {"nome":"","email":"","password":"","reppassword":"","cellphone":""};
    if(erros) {
        erros.errors.forEach(function(erro) {
            if (erro.path == "nome") {
                erroValidacao.nome = "erro",
                avisoErro.nome = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "email") {
                erroValidacao.email = "erro",
                avisoErro.email = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "senha") {
                erroValidacao.password = "erro",
                avisoErro.password = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "reppassword") {
                erroValidacao.reppassword = "erro",
                avisoErro.reppassword = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "telefone") {
                erroValidacao.cellphone = "erro",
                avisoErro.cellphone = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
        })
       if(msgErro != ""){
        %>
        <script>
                let msgErro ="<%= msgErro %>"
                notify("Erro(s) no preenchimento","Verifique o(s) campo(s) <br>  " + msgErro.replace(/&lt;/g,"<").replace(/&gt;/g,">"),
                 "error", "center", 5000)                        
            </script>
        <%
        }
    }
    if (dadosNotificacao) { %>
        <script>
                notify("<%= dadosNotificacao.titulo%>","<%= dadosNotificacao.mensagem%>", "<%= dadosNotificacao.tipo%>", "center")
        </script>
    <% } %>
  <%- include('../partials/navbar'); %>

  <main class="container">

    <aside class="modal" id="croppie-modal">
      <aside class="modal-content">
        <span class="close-modal" id="close-croppie">&times;</span>
        <aside id="croppie-container"></aside>
        <section class="btn">
        <button class="btns"  id="crop-btn">Cortar</button>
        <button class="btns" id="cancel-btn">Cancelar</button></section>
      </aside>
    </aside>

    <form action="/info_post" method="POST" enctype="multipart/form-data" class="form-editar-perfil">
        <h1>Editar Perfil</h1>

        <section id="banner_perfil" onclick="document.getElementById('cor_banner').click()" title="Clique para alterar a cor do banner">
            <img class="img-perfil fototo"  id="img-preview" src="<%= arquivo.imagem || 'https://cdn-icons-png.flaticon.com/512/219/219969.png' %>" alt="Foto de Perfil do Usuário">
            <input type="color" name="cor_banner" id="cor_banner" value="<%= valores && valores.cor_banner ? valores.cor_banner : '#C7D3DD' %>" required style="display:none;">
            <input type="file" name="imagem_perfil_usu" id="imagem_perfil_usu" style="display:none;">
        </section>

      <section class="form-group">

          </aside>
        </aside>
      </section>

      <section class="form-group" style="margin-top: 80px;">
        <label for="nome">Nome</label>
        <input type="text" name="nome" id="nome" value="<%= valores && (valores.nome || valores.name) ? (valores.nome || valores.name) : '' %>" required>
      </section>

      <section class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" value="<%= valores.email ? valores.email : '' %>" required>
      </section>


      <section class="form-group">
        <label for="telefone">Telefone</label>
        <input type="tel" name="telefone" id="telefone" value="<%= valores.telefone ? valores.telefone : '' %>"  maxlength="15" onload="mascaraTelefone()" required>
      </section>

      <section class="form-group">
      <label for="biografia">Biografia</label>
      <textarea name="biografia" id="biografia"><%= valores.biografia ? valores.biografia : '' %></textarea>
      </section>

      <section class="form-group">
        <label for="senha">Senha</label>
        <input type="password" name="senha" id="senha" placeholder="Não preencha este campo para manter a senha atual">
      </section>

      <section class="botoes">
      <input type="submit" value="Salvar Alterações" id="submit-btn" />
      <button type="button" id="cancel" onclick="window.location='/perfil1'">Cancelar</button></form>
    
  
    </section>

    <section class="outras-acoes">
     <h1 class="out">Outras Ações</h1>
    <form action="/excluir-perfil" method="POST" onsubmit="return confirmarExclusao()" class="form-excluir-perfil">
       <button type="submit" id="excluir-btn">
      Excluir Perfil
      </button>
     </form>
      </section>

      </section>
      



  </main>

  <%- include('../partials/footer'); %>


  <script>
  function confirmarExclusao() {
    return confirm('Tem certeza que deseja excluir seu perfil? Esta ação não pode ser desfeita!');
  }
</script>


    <script>
    document.getElementById('cor_banner').addEventListener('change', function(e) {
      document.getElementById('banner_perfil').style.backgroundColor = e.target.value;
    });

    var croppieInstance;

    const defaultImage = '../imagem/perfil-foto.png';

    $('#img-preview').on('click', function() {
        $('#imagem_perfil_usu').click();
    });

    if (!$('#img-preview').attr('src') || $('#img-preview').attr('src').trim() === '') {
        $('#img-preview').attr('src', defaultImage);
    }

    $('#imagem_perfil_usu').on('change', function() {
        var file = this.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                notify("Erro", "Apenas arquivos de imagem são permitidos!", "error", "center");
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#croppie-modal').css('display', 'flex');
                croppieInstance = new Croppie(document.getElementById('croppie-container'), {
                    viewport: { width: 200, height: 200, type: 'circle' },
                    boundary: { width: 300, height: 300 }
                });
                croppieInstance.bind({
                    url: e.target.result
                });
            };
            reader.readAsDataURL(file);
        }
    });

    $('#crop-btn').on('click', function() {
        croppieInstance.result('blob').then(function(blob) {
            var url = URL.createObjectURL(blob);
            $('#img-preview').attr('src', url);
            // Create file from blob
            var croppedFile = new File([blob], 'cropped.jpg', {type: blob.type});
            // Set to input
            var dt = new DataTransfer();
            dt.items.add(croppedFile);
            $('#imagem_perfil_usu')[0].files = dt.files;
            $('#croppie-modal').hide();
            croppieInstance.destroy();
        });
    });

    $('#cancel-btn').on('click', function() {
        $('#croppie-modal').hide();
        if (croppieInstance) croppieInstance.destroy();
    });

    $('#close-croppie').on('click', function() {
        $('#croppie-modal').hide();
        if (croppieInstance) croppieInstance.destroy();
    });

  </script>
</body>

</html>
