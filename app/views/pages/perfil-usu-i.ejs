<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Perfil</title>
  <link rel="stylesheet" href="/css/info.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" />
</head>
<body>
  <script src="/js/mascaras.js"></script>
    <script>
        function notify(title, text, type, position, timeout = 5000) {
            new Notify({
                status: type,
                title: title,
                text: text,
                effect: 'fade',
                speed: 500,
                showIcon: true,
                showCloseButton: true,
                autoclose: true,
                autotimeout: timeout,
                gap: 20,
                distance: 20,
                type: 1,
                position: position
            });
        }
    </script>
</head>

<body>
    <%
    let arquivo = {"imagem":"/imagem/img-perfil.png"}
        if(valores.img_perfil_pasta != null){
            arquivo.imagem = valores.img_perfil_pasta
        }else if(valores.img_perfil_banco != null){ 
            arquivo.imagem = valores.img_perfil_banco;
        }
    let  msgErro = "";
    let  erroValidacao =  {"name":"","email":"","password":"","reppassword":"","cellphone":""};
    let  avisoErro =  {"name":"","email":"","password":"","reppassword":"","cellphone":""};
    if(erros) {
        erros.errors.forEach(function(erro) {
            if (erro.path == "nome") {
                erroValidacao.name = "erro",
                avisoErro.name = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "email") {
                erroValidacao.email = "erro",
                avisoErro.email = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "senha") {
                erroValidacao.password = "erro",
                avisoErro.password = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "reppassword") {
                erroValidacao.reppassword = "erro",
                avisoErro.reppassword = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
            if (erro.path == "telefone") {
                erroValidacao.cellphone = "erro",
                avisoErro.cellphone = erro.msg
                msgErro += `* ${erro.msg} <br>`;
            }
        })
       if(msgErro != ""){
        %>
        <script>
                let msgErro ="<%= msgErro %>"
                notify("Erro(s) no preenchimento","Verifique o(s) campo(s) <br>  " + msgErro.replace(/&lt;/g,"<").replace(/&gt;/g,">"),
                 "error", "center", 5000)                        
            </script>
        <%
        }
    }
    if (dadosNotificacao) { %>
        <script>
                notify("<%= dadosNotificacao.titulo%>","<%= dadosNotificacao.mensagem%>", "<%= dadosNotificacao.tipo%>", "center")
        </script>
    <% } %>
  <%- include('../partials/navbar'); %>

  <main class="container">

    <div id="croppie-container" style="display:none;"></div>
    <button id="crop-btn" style="display:none;">Cortar</button>
    <button id="cancel-btn" style="display:none;">Cancelar</button>

    <form action="/info_post" method="POST" enctype="multipart/form-data" class="form-editar-perfil">
        <h1>Editar Perfil</h1>



      <section class="form-group">
        <div class="photo-color-row">
          <div class="photo-section">
            <label for="foto">Foto de Perfil</label>
            <input type="file" name="imagem_perfil_usu" id="imagem_perfil_usu" style="display:none;">
            <img class="img-perfil fototo"  id="img-preview" src="<%= arquivo.imagem %>">
          </div>
          <div class="color-section">
            <label for="nome">Cor do Banner</label>
            <div class="color-input-row">
              <input type="color" name="cor_banner" id="cor_banner" value="<%= valores && valores.cor_banner ? valores.cor_banner : '#C7D3DD' %>" required>
              <div id="color-preview" style="background-color: <%= valores && valores.cor_banner ? valores.cor_banner : '#C7D3DD' %>;"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="form-group">
        <label for="nome">Nome</label>
        <input type="text" name="nome" id="nome" value="<%= valores && valores.name ? valores.name : '' %>" required>
      </section>

      <section class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" value="<%= valores.email ? valores.email : '' %>" required>
      </section>


      <section class="form-group">
        <label for="telefone">Telefone</label>
        <input type="tel" name="telefone" id="telefone" value="<%= valores.telefone ? valores.telefone : '' %>"  maxlength="15" onload="mascaraTelefone()" required>
      </section>

      <section class="form-group">
      <label for="biografia">Biografia</label>
      <textarea name="biografia" id="biografia"><%= valores.biografia ? valores.biografia : '' %></textarea>
      </section>

      <section class="form-group">
        <label for="senha">Senha</label>
        <input type="password" name="senha" id="senha" placeholder="Não preencha este campo para manter a senha atual">
      </section>

      <input type="submit" value="Salvar Alterações" id="submit-btn" />
    </form>
  </main>

  <%- include('../partials/footer'); %>

  <script>
    document.getElementById('cor_banner').addEventListener('change', function(e) {
      document.getElementById('banner-preview').style.backgroundColor = e.target.value;
      document.getElementById('mini-banner').style.backgroundColor = e.target.value;
      document.getElementById('color-preview').style.backgroundColor = e.target.value;
    });

    var croppieInstance;
    var croppedBlob;

    $('#img-preview').on('click', function() {
        $('#imagem_perfil_usu').click();
    });

    $('#imagem_perfil_usu').on('change', function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#croppie-container').show();
                $('#crop-btn, #cancel-btn').show();
                croppieInstance = new Croppie(document.getElementById('croppie-container'), {
                    viewport: { width: 200, height: 200, type: 'circle' },
                    boundary: { width: 300, height: 300 }
                });
                croppieInstance.bind({
                    url: e.target.result
                });
            };
            reader.readAsDataURL(file);
        }
    });

    $('#crop-btn').on('click', function() {
        croppieInstance.result('blob').then(function(blob) {
            croppedBlob = blob;
            var url = URL.createObjectURL(blob);
            $('#img-preview').attr('src', url);
            $('#mini-foto').attr('src', url);
            $('#croppie-container').hide();
            $('#crop-btn, #cancel-btn').hide();
            croppieInstance.destroy();
        });
    });

    $('#cancel-btn').on('click', function() {
        $('#croppie-container').hide();
        $('#crop-btn, #cancel-btn').hide();
        if (croppieInstance) croppieInstance.destroy();
        croppedBlob = null;
    });

    $('form').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData();
        formData.append('nome', $('#nome').val());
        formData.append('email', $('#email').val());
        formData.append('telefone', $('#telefone').val());
        formData.append('biografia', $('#biografia').val());
        formData.append('senha', $('#senha').val());
        formData.append('cor_banner', $('#cor_banner').val());
        if (croppedBlob) {
            formData.append('imagem_perfil_usu', croppedBlob, 'cropped.jpg');
        } else {
            var file = $('#imagem_perfil_usu')[0].files[0];
            if (file) formData.append('imagem_perfil_usu', file);
        }
        fetch('/info_post', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                notify("Erro", "Falha ao salvar", "error", "center");
            }
        }).catch(err => {
            notify("Erro", "Erro de rede", "error", "center");
        });
    });
  </script>
</body>

</html>
