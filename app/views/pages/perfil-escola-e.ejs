<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Perfil Escola Canarinho </title>
    <link rel="stylesheet" href="css/vizu-perfil-usu.css">
    <link rel="stylesheet" href="css/perfil.css">
    <link rel="stylesheet" href="css/aval.css">
    <link rel="stylesheet" href="css/vizu.css">
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.js"></script>

</head>
<script>
        function notify(title, text, type, position, timeout = 5000) {
            new Notify({
                status: type,
                title: title,
                text: text,
                effect: 'fade',
                speed: 500,
                showIcon: true,
                showCloseButton: true,
                autoclose: true,
                autotimeout: timeout,
                gap: 20,
                distance: 20,
                type: 1,
                position: position
            });
        }
    </script>

    <%
        const tiposclassseCss = {
            'Educação Infantil': 'EI',
            'Ensino Fundamental I': 'EFI',
            'Ensino Fundamental II': 'EFII',
            'Ensino Fundamental': 'EFI',
            'Ensino Médio': 'EM',
            'Educação Integrada': 'EINT',
            'Cursos Técnicos': 'TEC',
            'Cursos Extracurriculares': 'CSO'
        }

        const acessibilidadeMap = {
            'RAMP': 'Rampa de Acesso',
            'CORR': 'Corrimão em Escadas e Rampas',
            'BRAP': 'Banheiro Adaptado',
            'ELEV': 'Elevador ou Plataforma Elevatória',
            'PSTL': 'Piso Tátil',
            'VAGA': 'Vaga Reservada para PcD',
            'Libras': 'Intérprete de Libras',
            'SIBR': 'Sinalização em Braille',
            'ALVS': 'Alarmes Visuais e Sonoros',
            'VIDL': 'Vídeos Legendados',
            'AEE': 'AEE (Atendimento Educacional Especializado)',
            'MADA': 'Materiais Didáticos Adaptados',
            'AVAD': 'Avaliações Adaptadas',
            'TNAS': 'Tecnologias Assistivas',
            'ACAT': 'Acessibilidade Atitudinal (Conscientização e Inclusão)'
        };

    %>

<body>
    <%- include('../partials/navbar'); %>

    <section class="perfil-container">
        <section class="perfil" id="pepe">
            <!-- <span class="logo-info"> -->
            <figure>
                <img src="<%= valores.img_perfil_banco || valores.img_perfil_pasta || '../imagem/escola-padrao.png' %>" alt="logo da escola" class="ft-perfil">
            </figure>
            <section class="info">
                <h1 class="nome-escola"><%= valores.name %></h1>
                <aside class="niveis">
                    <% (valores.tipos_ensino || []).forEach(tipo => { %>
                        <h5 class="escolaridade <%= tipo.trim().toUpperCase().substring(0, 3) %> <%= tiposclassseCss[tipo.trim()] || '' %>"><%= tipo %></h5>
                    <% }) %>
                </aside>
                   <section class="descricao">
                    <p class="localidade">
  <%= valores.logradouro %>, <%= valores.numero %>
  <% if (valores.bairro) { %> - <%= valores.bairro %> <% } %>
  <br>
  <%= valores.cidade %> - <%= valores.estado %>
  <br> <br>
</p>
                    <p class="instituicao "><%= valores.redes %></p>
                    <p class="ingresso"><%= valores.ingresso[0] || '' %></p>
                    </section>
            </section>
        </section>
        <section class="slider">

            <section class="slides">
                <!--radio butoons-->
                <input type="radio" name="radio-btn" id="radio1" checked>
                <input type="radio" name="radio-btn" id="radio2">
                <input type="radio" name="radio-btn" id="radio3">

                <!--imagem dos slide-->

                <section class="slide first">
                    <img src="<%= (valores.carouselImages && valores.carouselImages[0]) || '/imagem/image1.svg' %>" alt="imagem-1">
                </section>
                <section class="slide">
                    <img src="<%= (valores.carouselImages && valores.carouselImages[1]) || '/imagem/image3.svg' %>" alt="imagem-2">
                </section>
                <section class="slide">
                    <img src="<%= (valores.carouselImages && valores.carouselImages[2]) || '/imagem/image5.svg' %>" alt="imagem-3">
                </section>

                <section class="navegacao-auto">
                    <section class="auto-btn1"></section>
                    <section class="auto-btn2"></section>
                    <section class="auto-btn3"></section>
                </section>

            </section>

            <!-- Left and right controls -->
            <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
            <a class="next" onclick="changeSlide(1)">&#10095;</a>

            <section class="manual-navegacao">
                <label for="radio1" class="manual-btn"></label>
                <label for="radio2" class="manual-btn"></label>
                <label for="radio3" class="manual-btn"></label>
            </section>
        </section>
    </section>
    <hr>
    <section class="ultimo_tamanho">
    <section class="informacao">
        <h1 class="titulo-contato left" >Sobre a Escola</h1>
    <article class="descricao2">
        <%- (valores.sobre_escola || 'Este perfil ainda não escreveu nada sobre sua instituição.').replace(/\n/g, '<br>') %>
    </article>
        <h1 class="titulo-contato left">Sobre o Ensino</h1>
        <ul class="listinha">
            <%- (valores.sobre_ensino || 'Este perfil ainda não escreveu nada sobre seu ensino.').replace(/\n/g, '<br>') %>
        </ul>
        <h1 class="titulo-contato left">Sobre a Estrutura</h1>
        <ul class="listinha">
            <%- (valores.sobre_estrutura || 'Este perfil ainda não escreveu nada sobre sua estrutura.').replace(/\n/g, '<br>') %>

        </ul>
    </section>
    <p class="linha-vertical"></p>
<section class="lado">
    <section class="contatos">
        <h1 class="titulo-contato">Contato</h1>
            <section class="formas-contato">
                <figure><a href="<%=valores.instagram%> || https://www.instagram.com/" target="_blank"><img src="imagem/i1.svg" alt="Instagram" class="social-media" id="insta"></a></figure>
                <figure><a href="<%=valores.whatsapp%> || https://www.whatsapp.com" target="_blank"><img src="imagem/w1.svg" alt="WhattsApp" class="social-media" id="what"></a></figure>
                <figure><a href="<%=valores.whatsapp%> ||https://www.facebook.com" target="_blank"><img src="imagem/f1.svg" alt="Facebook" class="social-media" id="face"></a></figure>
                <figure><a href="tel:<%=valores.telefone%> || '' " target="_blank"><img src="imagem/t1.svg"class="social-media" alt="Telefone" id="telefone"></a></figure>
                <figure><a href="mailto:<%=valores.email%> || '' " target="_blank"><img src="imagem/e1.svg"class="social-media" alt="Email" id="email"></a></figure>
            </section>
    </section>
    <section class="contatos">

        <h1 class="titulo-contato">Acessibilidade</h1>
        <section class="formas-contato">
            <ul>
                <% if (valores.acessibilidade && valores.acessibilidade.length > 0) { %>
                    <% valores.acessibilidade.forEach(acel => { %>
                        <li class="acess <%= acel.trim().toUpperCase().substring(0, 3) %>"><%= acessibilidadeMap[acel.trim()] || acel %></li>
                    <% }) %>
                <% } else { %>
                    <li class="acess">Nenhum item de acessibilidade selecionado</li>
                <% } %>
            </ul>
        </section>
    </section>
    <section class="contatos">
    <h1 class="titulo-contato">Ingresso</h1>
        <section class="config-ingresso">
    <article class="tipos-de-ingresso">
        <ul>
            <% if (valores.ingresso && valores.ingresso.length > 0) { %>
                <% valores.ingresso.forEach(item => { %>
                    <li class="acess1"><%= item %></li>
                <% }) %>
            <% } else { %>
                <li class="acess1">Este perfil ainda não escreveu nada sobre seu ingresso.</li>
            <% } %>
        </ul>
        </section>
    </section>
    </section>
</section>

    <script src="script.js"></script>
    <hr id="section">

    <section class="media-avaliacoes">
        <h2>Média das Avaliações</h2>
        <section class="rating-display">
            <% for(let i=1; i<=5; i++) { %>
                <span class="star <%= i <= Math.round(mediaAvaliacao.media) ? 'filled' : '' %>"></span>
            <% } %>
            <span class="nota"><%= Math.round(mediaAvaliacao.media) %></span>
        </section>
        <p>Total de avaliações: <%= mediaAvaliacao.totalAvaliacoes %></p>
    </section>

    <section class="aval"><br>
        <h1>Avaliações</h1>
        <p class="avalinfo">Compartilhe suas impressões e experiência sobre essa instituição</p>
        <form action="/avaliar" method="post">
        <input type="hidden" name="id_usuario" value="<%= autenticado && autenticado.id || '' %>">
        <input type="hidden" name="id_escola" value="<%= valores.id_escola %>">
        <input type="hidden" name="id_usuario_escola" value="<%= valores.id_usuario %>">
        <span class="centro">
        <section class="rating">
            <input type="radio" value="5" name="rating" id="rating-5">
            <label for="rating-5"></label>
            <input type="radio" value="4" name="rating" id="rating-4">
            <label for="rating-4"></label>
            <input type="radio" value="3" name="rating" id="rating-3">
            <label for="rating-3"></label>
            <input type="radio" value="2" name="rating" id="rating-2">
            <label for="rating-2"></label>
            <input type="radio" value="1" name="rating" id="rating-1">
            <label for="rating-1"></label>
        </section>
        <section class="ratetext">
            <textarea name="ratetext" id="ratetext" maxlength="352" placeholder="Escreva aqui sua opinião"></textarea>
            <span id="caracteres">O número de caracteres foi atingido!</span>
        </section>
        <section> <button type="submit" id="enviar">Enviar</button></section></span></form>

        <section id="avaliacoes">
            <hr>
            <section id="caixa_comentarios">
                <% avaliacoes.forEach(aval => { %>
                <article id="comentario">
                    <section id="info_usuario_comentario">
                        <a href="/perfil-usuario?id=<%= aval.id_usuario %>">
                            <img src="<%= aval.img_perfil_banco && aval.img_perfil_banco.length > 0 ? `data:image/jpeg;base64,${aval.img_perfil_banco.toString('base64')}` : aval.img_perfil_pasta ? aval.img_perfil_pasta.replace('app/public', '') : 'https://cdn-icons-png.flaticon.com/512/219/219969.png' %>" id="foto_comentario">
                        </a>
                        <h3><a href="/perfil-usuario?id=<%= aval.id_usuario %>"><%= aval.nome_usuario || "Visitante" %></a></h3>
                    </section>
                    <p>• <%= aval.data_formatada %></p>
                    <section id="texto">
                        <%= aval.comentario %>
                        <section id="estrelas_bottom">
                            <% for (let i = 1; i <= 5; i++) { %>
                                <% if (i <= aval.nota) { %><span class="star-filled">★</span><% } else { %><span class="star-empty">☆</span><% } %>
                            <% } %>
                        </section>
                    </section>
                </article>
                <% }) %>
            </section>
        </section>

    </section>
<%- include('../partials/footer'); %>
<script>
    const textarea = document.getElementById('ratetext');
    const warning = document.getElementById('caracteres');

    textarea.addEventListener('input', () => {
        let caracteres = textarea.value.length;

        if (caracteres >= 352) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    });

    let counter = 1;
    setInterval(function(){
      document.getElementById('radio' + counter).checked = true;
      counter++;
      if(counter > 3){
        counter = 1;
      }
    }, 5000);

    function changeSlide(n) {
      counter += n;
      if (counter > 3) counter = 1;
      if (counter < 1) counter = 3;
      document.getElementById('radio' + counter).checked = true;
    }

    function updateSocialMediaImages() {
        const isDark = document.body.classList.contains('tema-escuro');
        const socialImages = document.querySelectorAll('.social-media');
        socialImages.forEach(img => {
            let src = img.src;
            if (isDark) {
                img.src = src.replace('1.svg', '2.svg');
            } else {
                img.src = src.replace('2.svg', '1.svg');
            }
        });
    }
    updateSocialMediaImages();
    const observer = new MutationObserver(updateSocialMediaImages);
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // AJAX form submission for reviews
    const form = document.querySelector('form[action="/avaliar"]');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            try {
                const response = await fetch('/avaliar', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    // Update average
                    const mediaSection = document.querySelector('.estrelas-media');
                    if (mediaSection) {
                        const stars = mediaSection.querySelectorAll('span');
                        const rounded = Math.round(data.mediaAvaliacao.media);
                        stars.forEach((star, i) => {
                            if (i < rounded) {
                                star.className = 'star-filled';
                                star.textContent = '★';
                            } else {
                                star.className = 'star-empty';
                                star.textContent = '☆';
                            }
                        });
                        const p = mediaSection.nextElementSibling;
                        if (p) {
                            p.textContent = `${Math.round(data.mediaAvaliacao.media)} / 5 (baseado em ${data.mediaAvaliacao.totalAvaliacoes} avaliações)`;
                        }
                    }
                    // Add new review
                    const caixa = document.getElementById('caixa_comentarios');
                    if (caixa) {
                        const article = document.createElement('article');
                        article.id = 'comentario';
                        article.innerHTML = `
                            <section id="info_usuario_comentario">
                                <a href="/perfil-usuario?id=${data.newAval.id_usuario}">
                                    <img src="${data.newAval.img_perfil_banco ? `data:image/jpeg;base64,${data.newAval.img_perfil_banco.toString('base64')}` : data.newAval.img_perfil_pasta ? data.newAval.img_perfil_pasta.replace('app/public', '') : 'https://cdn-icons-png.flaticon.com/512/219/219969.png'}" id="foto_comentario">
                                </a>
                                <h3><a href="/perfil-usuario?id=${data.newAval.id_usuario}">${data.newAval.nome_usuario || "Visitante"}</a></h3>
                            </section>
                            <p>• ${data.newAval.data_formatada}</p>
                            <section id="texto">
                                ${data.newAval.comentario}
                                <section id="estrelas_bottom">
                                    ${Array.from({length:5}, (_,i) => i < data.newAval.nota ? '<span class="star-filled">★</span>' : '<span class="star-empty">☆</span>').join('')}
                                </section>
                            </section>
                        `;
                        caixa.insertBefore(article, caixa.firstChild);
                    }
                    // Reset form
                    form.reset();
                    // Show success notification
                    notify('Avaliação realizada!', 'Sua avaliação foi criada com sucesso!', 'success', 'top-right');
                } else {
                    notify('Erro ao avaliar!', data.message, 'error', 'top-right');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                notify('Erro ao avaliar!', 'Erro interno. Tente novamente.', 'error', 'top-right');
            }
        });
    }

</script>
</body>
</html>


       <script>

    temp = 2
    let tempo_para_trocar;
    var delay = 3 * 1000
      
    function ChangeSlide() {
        var desaparecer = document.getElementById('slide'+temp);
        temp += 1;
        desaparecer.checked = false;
        if(document.getElementById('slide'+temp) == null){temp = 1}
        var aparecer = document.getElementById('slide'+temp)
        aparecer.checked = true;
        
    }
     
    function AutoRun(){
        if (!tempo_para_trocar) {
            tempo_para_trocar = setInterval(ChangeSlide, delay);
          }
    }

       </script>



