<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Perfil da Escola</title>
  <link rel="stylesheet" href="/css/perfil_esc_edi.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-notify@0.5.5/dist/simple-notify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" />
  <link rel="stylesheet" href="/css/modal.css">
</head>

<script>
    function notify(title, text, type, position, timeout = 5000) {
        new Notify({
            status: type,
            title: title,
            text: text,
            effect: 'fade',
            speed: 500,
            showIcon: true,
            showCloseButton: true,
            autoclose: true,
            autotimeout: timeout,
            gap: 20,
            distance: 20,
            type: 1,
            position: position
        });
    }
</script>

<body>
  <%- include('../partials/navbar'); %>

      <aside class="modal" id="croppie-modal">
      <aside class="modal-content">
        <span class="close-modal" id="close-croppie">&times;</span>
        <aside id="croppie-container"></aside>
        <section class="btn">
        <button class="btns crop-btn"  id="crop-btn">Cortar</button>
        <button class="btns cancel-btn" id="cancel-btn">Cancelar</button></section>
      </aside>
    </aside>

    <aside class="modal" id="croppie-modal-carousel-1">
      <aside class="modal-content">
        <span class="close-modal" id="close-croppie-carousel-1">&times;</span>
        <aside id="croppie-container-carousel-1"></aside>
        <section class="btn">
        <button class="btns crop-btn" id="crop-btn-carousel-1">Cortar</button>
        <button class="btns cancel-btn" id="cancel-btn-carousel-1">Cancelar</button></section>
      </aside>
    </aside>

    <aside class="modal" id="croppie-modal-carousel-2">
      <aside class="modal-content">
        <span class="close-modal" id="close-croppie-carousel-2">&times;</span>
        <aside id="croppie-container-carousel-2"></aside>
        <section class="btn">
        <button class="btns crop-btn" id="crop-btn-carousel-2">Cortar</button>
        <button class="btns cancel-btn" id="cancel-btn-carousel-2">Cancelar</button></section>
      </aside>
    </aside>

    <aside class="modal" id="croppie-modal-carousel-3">
      <aside class="modal-content">
        <span class="close-modal" id="close-croppie-carousel-3">&times;</span>
        <aside id="croppie-container-carousel-3"></aside>
        <section class="btn">
        <button class="btns crop-btn" id="crop-btn-carousel-3">Cortar</button>
        <button class="btns cancel-btn" id="cancel-btn-carousel-3">Cancelar</button></section>
      </aside>
    </aside>

  <!-- Mini sumário fixo -->
  <nav id="sumario">
    <ul>
      <li><a href="#info-gerais"> Informações Gerais</a></li>
      <li><a href="#carrossel"> Carrossel</a></li>
      <li><a href="#sobre-escola"> Sobre a Escola</a></li>
      <li><a href="#ingresso"> Ingresso</a></li>
      <li><a href="#ensino-turnos"> Ensino, Turnos e Rede</a></li>
      <li><a href="#rede-acessibilidade"> Acessibilidade</a></li>
      <li><a href="#contatos"> Contatos</a></li>
      <li><a href="#acoes"> Ações</a></li>
    </ul>
  </nav>

  <main class="conteudo">

    <form action="/editar_escola_post" method="POST" enctype="multipart/form-data">

      <!-- INFORMAÇÕES GERAIS -->
      <section id="info-gerais" class="caixa-sec">
        <h2> Informações Gerais</h2>

        <section class="image-upload">
          <img class="img-perfil fototo" id="img-preview" 
               src="<%= valores.img_perfil_pasta || '../imagem/escola-padrao.png' %>" 
               alt="Foto de Perfil">
          <input type="file" name="imagem_perfil_usu" id="imagem_perfil_usu" style="display:none;">
        </section>

        <label class="label-campo">Nome da Escola</label>
        <input class="input-campo" type="text" name="nomedaescola" value="<%= valores.nomedaescola || '' %>">

        <label class="label-campo">E-mail</label>
        <input class="input-campo" type="text" name="email" value="<%= valores.email || '' %>">

        <label class="label-campo">CNPJ</label>
        <input class="input-campo" type="text" name="cnpj" value="<%= valores.cnpj || '' %>" disabled>

        <label class="label-campo">Senha</label>
        <input class="input-campo" type="password" name="senha" placeholder="Não preencha para manter atual">

        <section class="linha">
          <section>
            <label class="label-campo">CEP</label>
            <input class="input-campo" type="text" name="cep" value="<%= valores.cep || '' %>">
          </section>
          <section>
            <label class="label-campo">Número</label>
            <input class="input-campo" type="text" name="adress_n" value="<%= valores.adress_n || '' %>">
          </section>
        </section>

        <label class="label-campo">Endereço</label>
        <input class="input-campo" type="text" name="endereco" value="<%= valores.endereco || '' %>">
      </section>

                <section class="carrossel caixa-sec" id="carrossel"> 
                                              <h2>Carrossel</h2>                
                        <section class="carousel-preview-section">

                            <section class="carousel-preview">
                                <section class="slides">
                                    <section class="slide">
                                        <img id="preview-slide-1" src="<%= valores.carouselImages && valores.carouselImages[0] ? valores.carouselImages[0] : '../imagem/placeholder.png' %>" alt="Slide 1">
                                    </section>
                                    <section class="slide">
                                        <img id="preview-slide-2" src="<%= valores.carouselImages && valores.carouselImages[1] ? valores.carouselImages[1] : '../imagem/placeholder.png' %>" alt="Slide 2">
                                    </section>
                                    <section class="slide">
                                        <img id="preview-slide-3" src="<%= valores.carouselImages && valores.carouselImages[2] ? valores.carouselImages[2] : '../imagem/placeholder.png' %>" alt="Slide 3">
                                    </section>
                                </section>
                            </section>
                        </section>
                                                <section class="carousel-upload box">

                            <section class="carousel-previews">
                                <section class="preview-item">
                                    <img id="carousel-preview-1" src="<%= valores.carouselImages && valores.carouselImages[0] ? valores.carouselImages[0] : '../imagem/placeholder.png' %>" alt="Preview 1">
                                    <input type="file" name="imagens_carrossel" id="carousel-input-1" accept="image/*">
                                </section>
                                <section class="preview-item">
                                    <img id="carousel-preview-2" src="<%= valores.carouselImages && valores.carouselImages[1] ? valores.carouselImages[1] : '../imagem/placeholder.png' %>" alt="Preview 2">
                                    <input type="file" name="imagens_carrossel" id="carousel-input-2" accept="image/*">
                                </section>
                                <section class="preview-item">
                                    <img id="carousel-preview-3" src="<%= valores.carouselImages && valores.carouselImages[2] ? valores.carouselImages[2] : '../imagem/placeholder.png' %>" alt="Preview 3">
                                    <input type="file" name="imagens_carrossel" id="carousel-input-3" accept="image/*">
                                </section>
                            </section>
                        </section>
                </section>

      <!-- SOBRE -->
      <section id="sobre-escola" class="caixa-sec">
        <h2> Sobre a Escola</h2>

        <label class="label-campo">Sobre a Escola</label>
        <textarea class="area" name="sobre_escola"><%= valores.sobre_escola || '' %></textarea>

        <label class="label-campo">Sobre o Ensino</label>
        <textarea class="area" name="sobre_ensino"><%= valores.sobre_ensino || '' %></textarea>

        <label class="label-campo">Sobre a Estrutura</label>
        <textarea class="area" name="sobre_estrutura"><%= valores.sobre_estrutura || '' %></textarea>
      </section>

      <!-- INGRESSO -->
      <section id="ingresso" class="caixa-sec">
        <h2> Ingresso</h2>

        <label class="label-campo">Tipos de Ingresso</label>
        <section class="ingresso-input-section">
          <input type="text" id="ingresso-input" class="input-campo" placeholder="Digite o tipo de ingresso">
          <button type="button" id="add-ingresso-btn" class="btn-add">Adicionar</button>
        </section>
        <ul id="ingresso-list" class="ingresso-list">
          <% if (valores.ingresso && valores.ingresso.length > 0) { %>
            <% valores.ingresso.forEach(function(item) { %>
              <li class="ingresso-item">
                <%= item %>
                <button type="button" class="remove-ingresso-btn" data-value="<%= item %>">Remover</button>
                <input type="hidden" name="ingresso[]" value="<%= item %>">
              </li>
            <% }); %>
          <% } %>
        </ul>
      </section>

      <!-- ENSINO -->
      <section id="ensino-turnos" class="caixa-sec">
        <h2> Tipos de Ensino, Turnos e Rede</h2>
        <section id="checkboxes">
          <section class="parts_checks">
            <ul>
              <p class="label-campo">Tipo de Ensino</p>
              <li><input type="checkbox" name="ensino" value="Educação Infantil" <%= valores.tipo_ensino?.includes('Educação Infantil') ? 'checked' : '' %>> Educação Infantil</li>
              <li><input type="checkbox" name="ensino" value="Ensino Fundamental I" <%= valores.tipo_ensino?.includes('Ensino Fundamental I') ? 'checked' : '' %>> Fundamental I</li>
              <li><input type="checkbox" name="ensino" value="Ensino Fundamental II" <%= valores.tipo_ensino?.includes('Ensino Fundamental II') ? 'checked' : '' %>> Fundamental II</li>
              <li><input type="checkbox" name="ensino" value="Ensino Médio" <%= valores.tipo_ensino?.includes('Ensino Médio') ? 'checked' : '' %>> Ensino Médio</li>
              <li><input type="checkbox" name="ensino" value="Cursos Técnicos" <%= valores.tipo_ensino?.includes('Cursos Técnicos') ? 'checked' : '' %>> Técnicos</li>
              <li><input type="checkbox" name="ensino" value="Cursos Extracurriculares" <%= valores.tipo_ensino?.includes('Cursos Extracurriculares') ? 'checked' : '' %>> Extracurriculares</li>
            </ul>
          </section>

          <section class="parts_checks">
            <ul>
              <p class="label-campo">Turnos</p>
              <li><input type="checkbox" name="turno" value="Manhã" <%= valores.turnos?.includes('Manhã') ? 'checked' : '' %>> Manhã</li>
              <li><input type="checkbox" name="turno" value="Tarde" <%= valores.turnos?.includes('Tarde') ? 'checked' : '' %>> Tarde</li>
              <li><input type="checkbox" name="turno" value="Integral" <%= valores.turnos?.includes('Integral') ? 'checked' : '' %>> Integral</li>
              <li><input type="checkbox" name="turno" value="Noite" <%= valores.turnos?.includes('Noite') ? 'checked' : '' %>> Noite</li>
              <li><input type="checkbox" name="turno" value="Sábado" <%= valores.turnos?.includes('Sábado') ? 'checked' : '' %>> Sábado</li>
            </ul>
          </section>
        </section>
                  <section class="parts_checks">
            <ul>
              <p class="label-campo">Rede</p>
              <li><input type="checkbox" name="rede" value="Municipal" <%= valores.redes?.includes('Municipal') ? 'checked' : '' %>> Municipal</li>
              <li><input type="checkbox" name="rede" value="Estadual" <%= valores.redes?.includes('Estadual') ? 'checked' : '' %>> Estadual</li>
              <li><input type="checkbox" name="rede" value="Particular" <%= valores.redes?.includes('Particular') ? 'checked' : '' %>> Particular</li>
            </ul>
          </section>
      </section>

      <!-- REDE -->
      <section id="rede-acessibilidade" class="caixa-sec">
        <h2>Acessibilidade</h2>

          <section class="parts_checks">
            <ul>
<p class="label-campo" style="margin-top: 5%">Acessibilidade Física</p>
<li><input type="checkbox" name="acessibilidade" value="RAMP" <%= valores.acessibilidade?.includes('RAMP') ? 'checked' : '' %>> Rampa de Acesso</li>
<li><input type="checkbox" name="acessibilidade" value="CORR" <%= valores.acessibilidade?.includes('CORR') ? 'checked' : '' %>> Corrimão em Escadas e Rampas</li>
<li><input type="checkbox" name="acessibilidade" value="BRAP" <%= valores.acessibilidade?.includes('BRAP') ? 'checked' : '' %>> Banheiro Adaptado</li>
<li><input type="checkbox" name="acessibilidade" value="ELEV" <%= valores.acessibilidade?.includes('ELEV') ? 'checked' : '' %>> Elevador ou Plataforma Elevatória</li>
<li><input type="checkbox" name="acessibilidade" value="PSTL" <%= valores.acessibilidade?.includes('PSTL') ? 'checked' : '' %>> Piso Tátil</li>
<li><input type="checkbox" name="acessibilidade" value="VAGA" <%= valores.acessibilidade?.includes('VAGA') ? 'checked' : '' %>> Vaga Reservada para PcD</li>

<p class="label-campo" style="margin-top: 5%">Acessibilidade Comunicacional</p>
<li><input type="checkbox" name="acessibilidade" value="Libras" <%= valores.acessibilidade?.includes('Libras') ? 'checked' : '' %>> Intérprete de Libras</li>
<li><input type="checkbox" name="acessibilidade" value="SIBR" <%= valores.acessibilidade?.includes('SIBR') ? 'checked' : '' %>> Sinalização em Braille</li>
<li><input type="checkbox" name="acessibilidade" value="ALVS" <%= valores.acessibilidade?.includes('ALVS') ? 'checked' : '' %>> Alarmes Visuais e Sonoros</li>
<li><input type="checkbox" name="acessibilidade" value="VIDL" <%= valores.acessibilidade?.includes('VIDL') ? 'checked' : '' %>> Vídeos Legendados</li>

<p class="label-campo" style="margin-top: 5%">Acessibilidade Pedagógica</p>
<li><input type="checkbox" name="acessibilidade" value="AEE" <%= valores.acessibilidade?.includes('AEE') ? 'checked' : '' %>> AEE (Atendimento Educacional Especializado)</li>
<li><input type="checkbox" name="acessibilidade" value="MADA" <%= valores.acessibilidade?.includes('MADA') ? 'checked' : '' %>> Materiais Didáticos Adaptados</li>
<li><input type="checkbox" name="acessibilidade" value="AVAD" <%= valores.acessibilidade?.includes('AVAD') ? 'checked' : '' %>> Avaliações Adaptadas</li>
<li><input type="checkbox" name="acessibilidade" value="TNAS" <%= valores.acessibilidade?.includes('TNAS') ? 'checked' : '' %>> Tecnologias Assistivas</li>
<li><input type="checkbox" name="acessibilidade" value="ACAT" <%= valores.acessibilidade?.includes('ACAT') ? 'checked' : '' %>> Acessibilidade Atitudinal (Conscientização e Inclusão)</li>
            </ul>
          </section>
        </section>
      </section>

      <!-- CONTATOS -->
      <section id="contatos" class="caixa-sec">
        <h2> Contatos</h2>
        <label class="label-campo">Instagram</label>
        <input class="input-campo" type="text" name="instagram" value="<%= valores.instagram || '' %>">

        <label class="label-campo">Facebook</label>
        <input class="input-campo" type="text" name="facebook" value="<%= valores.facebook || '' %>">

        <label class="label-campo">Whatsapp</label>
        <input class="input-campo" type="text" name="whatsapp" value="<%= valores.whatsapp || '' %>">

        <label class="label-campo">Telefone</label>
        <input class="input-campo" type="text" name="telefone_contato" value="<%= valores.telefone_contato || '' %>">

        <label class="label-campo">E-mail</label>
        <input class="input-campo" type="text" name="email_contato" value="<%= valores.email_contato || '' %>">
      </section>

      <!-- AÇÕES -->
      <section id="acoes" class="caixa-sec">

        <section class="botoes-acoes">
          <button type="submit" id="salvar_button">Salvar</button>
          <form action="/excluir-perfil" method="POST" onsubmit="return confirmarExclusao()" class="form-excluir">
            <button type="submit" id="excluir-btn">Excluir Perfil</button>
          </form>
        </section>
      </section>
    </form>
  </main>

  <script>
    // Scroll suave no sumário
    document.querySelectorAll('#sumario a').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute('href'));
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    function confirmarExclusao() {
      return confirm('Tem certeza que deseja excluir seu perfil? Esta ação não pode ser desfeita!');
    }
  </script>
</body>

  <script>
  function confirmarExclusao() {
    return confirm('Tem certeza que deseja excluir seu perfil? Esta ação não pode ser desfeita!');
  }
</script>

    <script>
    var croppieInstance;
    var croppedBlob;

    $('#img-preview').on('click', function() {
        $('#imagem_perfil_usu').click();
    });

    $('#imagem_perfil_usu').on('change', function() {
        var file = this.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert("Apenas arquivos de imagem são permitidos!");
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#croppie-modal').css('display', 'flex');
                croppieInstance = new Croppie(document.getElementById('croppie-container'), {
                    viewport: { width: 200, height: 200 },
                    boundary: { width: 300, height: 300 }
                });
                croppieInstance.bind({
                    url: e.target.result
                });
            };
            reader.readAsDataURL(file);
        }
    });

    $('#crop-btn').on('click', function() {
        croppieInstance.result('blob').then(function(blob) {
            croppedBlob = blob;
            var url = URL.createObjectURL(blob);
            $('#img-preview').attr('src', url);
            $('#croppie-modal').hide();
            croppieInstance.destroy();
        });
    });

    $('#cancel-btn').on('click', function() {
        $('#croppie-modal').hide();
        if (croppieInstance) croppieInstance.destroy();
        croppedBlob = null;
    });

    $('#close-croppie').on('click', function() {
        $('#croppie-modal').hide();
        if (croppieInstance) croppieInstance.destroy();
        croppedBlob = null;
    });

    // Carousel image cropping
    var croppieInstances = {};
    var croppedBlobs = {};

    for (let i = 1; i <= 3; i++) {
        $('#carousel-input-' + i).on('change', function() {
            var index = this.id.split('-')[2];
            var file = this.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert("Apenas arquivos de imagem são permitidos!");
                    return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#croppie-modal-carousel-' + index).css('display', 'flex');
                    croppieInstances[index] = new Croppie(document.getElementById('croppie-container-carousel-' + index), {
                        viewport: { width: 300, height: 200 },
                        boundary: { width: 400, height: 300 }
                    });
                    croppieInstances[index].bind({
                        url: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        $('#crop-btn-carousel-' + i).on('click', function() {
            var index = this.id.split('-')[3];
            croppieInstances[index].result('blob').then(function(blob) {
                croppedBlobs[index] = blob;
                var url = URL.createObjectURL(blob);
                $('#carousel-preview-' + index).attr('src', url);
                $('#preview-slide-' + index).attr('src', url);
                // Create new File from blob and set to input
                var newFile = new File([blob], 'cropped-carousel-' + index + '.png', { type: 'image/png' });
                var dt = new DataTransfer();
                dt.items.add(newFile);
                $('#carousel-input-' + index)[0].files = dt.files;
                $('#croppie-modal-carousel-' + index).hide();
                croppieInstances[index].destroy();
            });
        });

        $('#cancel-btn-carousel-' + i).on('click', function() {
            var index = this.id.split('-')[3];
            $('#croppie-modal-carousel-' + index).hide();
            if (croppieInstances[index]) croppieInstances[index].destroy();
            croppedBlobs[index] = null;
        });

        $('#close-croppie-carousel-' + i).on('click', function() {
            var index = this.id.split('-')[3];
            $('#croppie-modal-carousel-' + index).hide();
            if (croppieInstances[index]) croppieInstances[index].destroy();
            croppedBlobs[index] = null;
        });
    }

    // Carousel preview auto-slide
    let currentSlide = 0;
    const slideElements = $('.carousel-preview .slide');
    const slides = $('.carousel-preview .slides');

    function showSlide(index) {
        slides.css('transform', `translateX(-${index * 100}%)`);
        currentSlide = index;
    }

    function nextSlide() {
        currentSlide = (currentSlide < slideElements.length - 1) ? currentSlide + 1 : 0;
        showSlide(currentSlide);
    }

    // Auto-slide every 3 seconds
    setInterval(nextSlide, 3000);

    // Set default images based on theme
    function setDefaultImages() {
        const isDark = document.body.classList.contains('tema-escuro');
        const defaults = isDark ? ['image2.svg', 'image4.svg', 'image6.svg'] : ['image1.svg', 'image3.svg', 'image5.svg'];
        for (let i = 1; i <= 3; i++) {
            const slideImg = $('#preview-slide-' + i);
            const previewImg = $('#carousel-preview-' + i);
            if (slideImg.attr('src') === '../imagem/placeholder.png') {
                slideImg.attr('src', '../imagem/' + defaults[i-1]);
            }
            if (previewImg.attr('src') === '../imagem/placeholder.png') {
                previewImg.attr('src', '../imagem/' + defaults[i-1]);
            }
        }
    }

    // Set on load
    setDefaultImages();

    // Listen for theme change (assuming theme toggle adds/removes class)
    // If there's a theme toggle button, it should trigger this
    // For now, assume it's manual, but to make it dynamic, perhaps poll or use mutation observer
    // Simple way: call setDefaultImages when needed, but since no toggle in this file, set on load


</script>

<script>
  // Viacep API integration for auto-filling address fields based on CEP
  document.getElementById('cep').addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    if (cep.length === 8) {
      fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
          if (!data.erro) {
            // Auto-fill address fields
            if (data.logradouro) {
              document.querySelector('input[name="endereco"]').value = data.logradouro;
            }
            if (data.localidade) {
              document.querySelector('input[name="cidade"]').value = data.localidade;
            }
            if (data.uf) {
              // Optionally fill state if you have a state field
              // document.querySelector('input[name="estado"]').value = data.uf;
            }
          } else {
            // CEP not found
            alert('CEP não encontrado.');
          }
        })
        .catch(() => {
          alert('Erro ao buscar CEP.');
        });
    }
  });
</script>

<% if (dadosNotificacao) { %>
<script>
    notify("<%= dadosNotificacao.titulo %>", "<%= dadosNotificacao.mensagem %>", "<%= dadosNotificacao.tipo %>", "center");
</script>
<% } %>

<script>
  // Ingresso list management
  $('#add-ingresso-btn').on('click', function() {
    const input = $('#ingresso-input');
    const value = input.val().trim();
    if (value) {
      const list = $('#ingresso-list');
      const li = $('<li class="ingresso-item"></li>');
      li.html(`${value} <button type="button" class="remove-ingresso-btn" data-value="${value}">Remover</button><input type="hidden" name="ingresso[]" value="${value}">`);
      list.append(li);
      input.val('');
    }
  });

  $(document).on('click', '.remove-ingresso-btn', function() {
    $(this).closest('.ingresso-item').remove();
  });
</script>

</html>
